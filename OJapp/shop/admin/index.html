<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OJapp Shop Admin</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    background: #f7f9fc;
    padding: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: 700;
  }
  .form-box {
    background: #ffffff;
    border-radius: 16px;
    padding: 20px;
    max-width: 440px;
    margin: 0 auto;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  }

  .input-group {
    margin-bottom: 16px;
  }
  .input-group label {
    font-size: 14px;
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
  }
  .input-group input,
  .input-group select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #dde3ea;
    background: #fdfdfd;
    font-size: 15px;
  }

  .thumb-preview {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 16px;
    object-fit: cover;
    border: 1px solid #e5e5e5;
    margin-bottom: 12px;
    display: none;
  }

  .submit-btn {
    width: 100%;
    background: linear-gradient(135deg, #2bb7ff, #4d8cff);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
    transition: 0.2s;
  }

  .submit-btn:active { opacity: 0.7; }

  .result-box {
    text-align: center;
    margin-top: 20px;
    font-size: 15px;
    color: #333;
    display: none;
  }

  .logout-btn {
    margin-top: 20px;
    padding: 10px 18px;
    background: #ff4b7d;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  .logout-btn:hover { background: #ff2f68; }
  .primary-btn {
    background: linear-gradient(90deg, #4fc3ff, #3a7bff);
    border: none;
    padding: 12px 20px;
    color: white;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    margin-top: 15px;
  }
  .primary-btn:hover {
    opacity: 0.9;
  }
</style>
</head>
<body>

<h1 id="page-title">ğŸ›’ OJapp Shop Admin</h1>
<div id="author-icon-box" style="margin-bottom:30px;"></div>
<!-- ================================
     ä½œè€…ã‚¢ã‚¤ã‚³ãƒ³æå‡ºã‚¨ãƒªã‚¢
================================ -->
<div class="form-box" id="author-icon-box" style="margin-bottom: 30px;">
  <h3 style="margin-bottom: 10px;">ä½œè€…ã‚¢ã‚¤ã‚³ãƒ³</h3>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <img id="author-icon-preview" class="thumb-preview" style="display:none">

  <div class="input-group">
    <label id="author-icon-label">ä½œè€…ã‚¢ã‚¤ã‚³ãƒ³ã‚’æå‡ºã—ã¦ãã ã•ã„ï¼ˆPNGæ¨å¥¨ï¼‰</label>
    <input type="file" id="author-icon-input" accept="image/*">
  </div>

  <button class="submit-btn" id="author-icon-submit">ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>

  <div class="result-box" id="author-icon-result"></div>
</div>


<!-- ================================
     å•†å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
================================ -->
<div class="form-box">

  <img id="preview" class="thumb-preview">

  <div class="input-group">
    <label>ã‚µãƒ ãƒç”»åƒ</label>
    <input type="file" id="thumb" accept="image/*">
  </div>

  <div class="input-group">
    <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
    <input type="text" id="title">
  </div>

  <div class="input-group">
    <input type="hidden" id="author" name="author">
  </div>

  <div class="input-group">
    <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
    <input type="text" id="category">
  </div>

  <div class="input-group">
    <label>ä¾¡æ ¼ï¼ˆæ•°å­—ã®ã¿ï¼‰</label>
    <input type="number" id="price">
  </div>

  <div class="input-group">
    <label>å…¬é–‹ã™ã‚‹</label>
    <select id="visible">
      <option value="1">å…¬é–‹</option>
      <option value="0">éå…¬é–‹</option>
    </select>
  </div>

  <button class="submit-btn" id="submit">å•†å“ã‚’ç™»éŒ²ã™ã‚‹</button>

  <button id="logout-btn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

  <div class="result-box" id="result"></div>
</div>
<script>
// ============================================
// å…±æœ‰ï¼šBase64URLï¼ˆä½œè€…å â†’ author_keyï¼‰
// ============================================
function encodeAuthorName(name) {
  const utf8 = new TextEncoder().encode(name);
  let binary = "";
  utf8.forEach(b => binary += String.fromCharCode(b));
  return btoa(binary)
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/, "");
}


// ============================================
// DOMContentLoadedï¼ˆå…¨éƒ¨ã“ã“ã§å‹•ã‹ã™ï¼‰
// ============================================
document.addEventListener("DOMContentLoaded", () => {

  const API_BASE = "https://ojshop-fav.trc-wasps.workers.dev";
  const KEY = "ojshop-admin-designer";

  // ----------------------------------------------------
  // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  // ----------------------------------------------------
  let designer = localStorage.getItem(KEY);

  if (!designer) {
    const input = prompt("ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼å°‚ç”¨ãƒšãƒ¼ã‚¸ã§ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");

    if (!input) {
      alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ");
      location.href = "/OJapp/shop/";
      return;
    }

    if (!input.endsWith("778")) {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚");
      location.href = "/OJapp/shop/";
      return;
    }

    designer = input.slice(0, -3);
    localStorage.setItem(KEY, designer);
    alert(`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ã‚ˆã†ã“ã ${designer} ã•ã‚“`);
  }


  // ----------------------------------------------------
  // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
  // ----------------------------------------------------
  const suffix = designer.endsWith("s") ? "â€™" : "'s";
  document.getElementById("page-title").textContent =
    `${designer}${suffix} OJapp Shop`;


  // ----------------------------------------------------
  // ä½œè€…å hidden ã«ã‚»ãƒƒãƒˆ
  // ----------------------------------------------------
  document.getElementById("author").value = designer;


  // ----------------------------------------------------
  // ä½œè€…ã‚¢ã‚¤ã‚³ãƒ³ UI åˆ‡æ›¿
  // ----------------------------------------------------
  (async () => {

    const authorKey = encodeAuthorName(designer);
    const iconURL = `${API_BASE}/shop/r2/authors/${authorKey}.png`;
    const box = document.getElementById("author-icon-box");

    // ç”»åƒå­˜åœ¨ãƒã‚§ãƒƒã‚¯
    const exists = await fetch(iconURL, { method: "HEAD" })
      .then(r => r.ok)
      .catch(() => false);

    if (exists) {
      // ---------- ç™»éŒ²æ¸ˆã¿ UI ----------
      box.innerHTML = `
        <h3 style="margin-bottom:10px;">ä½œè€…ã‚¢ã‚¤ã‚³ãƒ³</h3>
        <img src="${iconURL}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:15px;">
        <p style="font-size:14px;margin-bottom:10px;">ç™»éŒ²æ¸ˆã¿ã®ã‚¢ã‚¤ã‚³ãƒ³ã§ã™</p>
        <input type="file" id="author-icon-input" accept="image/*">
        <button class="submit-btn" id="author-icon-update">ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´ã™ã‚‹</button>
        <div class="result-box" id="author-icon-result" style="display:none;"></div>
      `;

      // æ›´æ–°ãƒœã‚¿ãƒ³
      document.getElementById("author-icon-update").addEventListener("click", async () => {
        const file = document.getElementById("author-icon-input").files[0];
        const result = document.getElementById("author-icon-result");
        if (!file) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");

        const res = await fetch(`${API_BASE}/shop/admin/icon?author_key=${authorKey}`, {
          method: "POST",
          body: file
        });

        const json = await res.json();
        result.style.display = "block";

        result.innerHTML = json.ok
          ? "ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"
          : "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      });

      return; // â˜… æœªç™»éŒ² UI ã¯å®Ÿè¡Œã—ãªã„
    }


    // ---------- æœªç™»éŒ² UI ----------
    const preview = document.getElementById("author-icon-preview");
    const input = document.getElementById("author-icon-input");
    const submitBtn = document.getElementById("author-icon-submit");
    const result = document.getElementById("author-icon-result");

    input.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";
    });

    submitBtn.addEventListener("click", async () => {
      const file = input.files[0];
      if (!file) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");

      const res = await fetch(`${API_BASE}/shop/admin/icon?author_key=${authorKey}`, {
        method: "POST",
        body: file
      });

      const json = await res.json();
      result.style.display = "block";

      result.innerHTML = json.ok
        ? `ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼<br>${json.url}`
        : "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    });

  })();


  // ----------------------------------------------------
  // ã‚µãƒ ãƒç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  // ----------------------------------------------------
  document.getElementById("thumb").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const preview = document.getElementById("preview");
    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";
  });


  // ----------------------------------------------------
  // å•†å“ç™»éŒ²
  // ----------------------------------------------------
  document.getElementById("submit").addEventListener("click", async () => {

    const file = document.getElementById("thumb").files[0];
    const title = document.getElementById("title").value;
    const author = designer;
    const category = document.getElementById("category").value;
    const price = document.getElementById("price").value;

    if (!file || !title) {
      alert("ç”»åƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™ï¼");
      return;
    }

    const product_id = crypto.randomUUID();
    const author_key = encodeAuthorName(author);

    // ---------- â‘  R2ã«ã‚µãƒ ãƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ----------
    const upRes = await fetch(
      `${API_BASE}/shop/admin/thumb?product_id=${product_id}&author_key=${author_key}`,
      { method: "POST", body: file }
    );

    const upJson = await upRes.json();
    if (!upJson.ok) {
      alert("ã‚µãƒ ãƒç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
      return;
    }

    // ---------- â‘¡ D1 ã«å•†å“ç™»éŒ² ----------
    const payload = {
      product_id,
      title,
      author,
      author_key,
      category,
      product_url: "",
      price: Number(price),
      thumbnail: `thumbs/${author_key}/${product_id}.png`
    };

    const res = await fetch(`${API_BASE}/shop/admin/item`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    const box = document.getElementById("result");
    box.style.display = "block";

    box.innerHTML = json.ok
      ? `ç™»éŒ²å®Œäº†ï¼<br>product_idï¼š<b>${json.product_id}</b>`
      : "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  });


  // ----------------------------------------------------
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  // ----------------------------------------------------
  document.getElementById("logout-btn").addEventListener("click", () => {
    if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(KEY);
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼");
    location.reload();
  });

});
</script>

</body>
</html>
